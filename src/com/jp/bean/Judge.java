package com.jp.bean;

import javax.swing.JOptionPane;
import javax.swing.SwingUtilities;

import com.jp.algorithm.EvaluationFunction;
import com.jp.ui.BlackTimer;
import com.jp.ui.ChessBoard;
import com.jp.ui.ChessPoint;
import com.jp.ui.MainFrame;
import com.jp.ui.WhiteTimer;
import com.jp.ui.event.ChessBoardModelEvent;
import com.jp.ui.event.ChessBoardModelListener;
import com.jp.ui.event.RoleChangeEvent;
import com.jp.ui.event.RoleChangeListener;
import com.jp.ui.model.ChessBoardModel;
import com.jp.ui.model.DefaultChessBoardModel;

/**
 * Judge类，裁判对象类，用于在游戏过程中接管游戏
 * 
 * @author 蒋鹏
 */
public class Judge implements RoleChangeListener,ChessBoardModelListener{
	private static Judge judge;
//构造方法
	/** 构造方法，初始化属性 */
	private Judge() {
		
	}
//普通方法
	/**
	 * init方法，使得裁判对象开始监听角色转换
	 */
	public void init(){
		ChessBoardModel cbm=ChessBoard.getInstance().getModel();
		DefaultChessBoardModel dcbm=(DefaultChessBoardModel)cbm;
		dcbm.addRoleChangeListener(this);
		dcbm.addChessBoardModelListener(this);
	}
	/**
	 * destory方法，移除裁判对象对角色转换的监听
	 */
	public void destory(){
		WhiteTimer wt=WhiteTimer.getInstance();
		BlackTimer bt=BlackTimer.getInstance();
		wt.stop();
		bt.stop();
		ChessBoardModel cbm=ChessBoard.getInstance().getModel();
		DefaultChessBoardModel dcbm=(DefaultChessBoardModel)cbm;
		dcbm.removeRoleChangeListener(this);
		dcbm.removeChessBoardModelListener(this);
	}
	/**
	 * chessBoardChanged,向棋盘模型中添加棋子后触发的事件处理函数
	 */
	@Override
	public void chessBoardChanged(ChessBoardModelEvent e) {
		ChessBoardModel cbm=ChessBoard.getInstance().getModel();
		DefaultChessBoardModel dcbm=(DefaultChessBoardModel)cbm;
		boolean result=EvaluationFunction.isGameOver(dcbm);
		//根据棋局局势判断棋局是否已经结束
		if(result){
			destory();
			MainFrame.getInstance().getGstop().doClick();
			char role=dcbm.getLastStepChessColor();
			if(role==ChessPoint.BLACKCHESS){
				SwingUtilities.invokeLater(new Runnable() {
					@Override
					public void run() {
						JOptionPane.showMessageDialog(MainFrame.getInstance(), "黑方获胜！");
					}
				});
			}
			if(role==ChessPoint.WHITECHESS){
				SwingUtilities.invokeLater(new Runnable() {
					@Override
					public void run() {
						JOptionPane.showMessageDialog(MainFrame.getInstance(), "白方获胜！");
					}
				});
			}
		}
	}
	/**
	 * roleChanged，角色转换后的处理方法 
	 */
	@Override
	public void roleChanged(RoleChangeEvent e) {
		new MoveCalculate().execute();
	}
	/**
	 * 获得裁判单例对象
	 * @return judge 裁判对象
	 */
	public static Judge getInstance() {
		if(judge==null){
			judge=new Judge();
		}
		return judge;
	}
}
